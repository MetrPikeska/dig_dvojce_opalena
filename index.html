<!DOCTYPE html>
<html>
    <head>
        <title>OPALGIS</title>
        <meta charset="utf-8" />
        <meta name="description" content="Webová aplikace pro Ski areál Opálená">
        <meta name="keywords" content="HTML, CSS, JavaScript, Leaflet, Olomouc, Ortofoto, jQuery">
        <meta name="author" content="Petr Mikeska, Petr Havel, Matouš Olšanský, Vojtěch Svoboda">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link type="text/css" rel="stylesheet" href="leaflet.css" />
        <link type="text/css" rel="stylesheet" href="visual.css" />
        <link rel="icon" type="image/png" href="favicon.png" />
        <link href="https://vjs.zencdn.net/7.20.3/video-js.css" rel="stylesheet">
        <script src="https://vjs.zencdn.net/7.20.3/video.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
        <script src="https://unpkg.com/leaflet/dist/leaflet-src.js"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    </head>
    
<body>
    <div id="header">
        <h1>SKI AREÁL OPÁLENÁ</h1>
        <h2>VYGEO PROJEKT</h2>
    </div>
    
    <div id="sheepInfo">
        <span class="count">–</span>
        <span class="label">Počet ovcí na svahu</span>
        <br>
        <button id="showGraphBtn">Zobrazit graf</button>
    </div>

    <!-- Modal pro graf -->
    <div id="graphModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:70%; background:white; border:2px solid #007ddd; border-radius:10px; padding:20px; z-index:2000; overflow:auto;">
        <h3>Statistika počtu ovcí</h3>
        <canvas id="sheepChart"></canvas>
        <br>
        <button onclick="document.getElementById('graphModal').style.display='none'">Zavřít</button>
    </div>

    <div id="map"></div>
    <div class="home-btn" id="homeButton" title="Návrat na domovskou pozici"><i class="fas fa-home"></i></div>
    <div class="find-location-btn" id="findLocationButton" title="Najít mou polohu"><i class="fas fa-map-marker-alt"></i></div>

    <script>
        $(document).ready(function () {
            const homePoint = [49.5535106, 18.3143814];
            const webcamPoint = [49.55469, 18.31718];
            let currentLocationMarker;
            
            const map = L.map('map', {
                center: homePoint,
                zoom: 17
            });

            const API_KEY = '5ZtGuQEtvV37xyC_1IJnglc8ZgP53ehgvFqTiHuaFoI';

            const customIcon = L.icon({
                iconUrl: 'webcam.svg',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            const currentLocationIcon = L.icon({
                iconUrl: 'bod_lokace.svg',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            const webcamMarker = L.marker(webcamPoint, { icon: customIcon }).bindPopup(
    `<div style="width: 500px; height: 300px; display: flex; justify-content: center; align-items: center;">
        <video-js id="webcam-player" class="vjs-default-skin" controls autoplay muted preload="auto"></video-js>
    </div>`, 
    { maxWidth: 500, minWidth: 500, maxHeight: 300 }
).addTo(map);

        // Inicializace HLS přehrávače
        map.on('popupopen', function (e) {
            const popupContent = e.popup.getContent();
            if (popupContent.includes('webcam-player')) {
                const player = videojs('webcam-player', {
                    techOrder: ['html5'],
                    autoplay: true,
                    controls: true,
                    muted: true,
                    preload: 'auto'
                });

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource('https://stream.teal.cz/hls/cam273.m3u8');
                    hls.attachMedia(player.tech_.el_);
                } else if (player.tech_.el_.canPlayType('application/vnd.apple.mpegurl')) {
                    player.src({ src: 'https://stream.teal.cz/hls/cam273.m3u8', type: 'application/vnd.apple.mpegurl' });
                }
                e.popup.videoPlayer = player;
            }
        });

        map.on('popupclose', function (e) {
            if (e.popup.videoPlayer) {
                e.popup.videoPlayer.dispose();
                e.popup.videoPlayer = null;
            }
        });

        const mapyletecka = L.tileLayer(`https://api.mapy.cz/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`, {
            minZoom: 17,
            maxZoom: 19,
            attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
        }).addTo(map);

        const mapycz = L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}`, {
            minZoom: 17,
            maxZoom: 19,
            attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
        });

        const mapywintercz = L.tileLayer(`https://api.mapy.cz/v1/maptiles/winter/256/{z}/{x}/{y}?apikey=${API_KEY}`, {
            minZoom: 17,
            maxZoom: 19,
            attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
        });

        const mapyoutdoor = L.tileLayer(`https://api.mapy.cz/v1/maptiles/outdoor/256/{z}/{x}/{y}?apikey=${API_KEY}`, {
            minZoom: 17,
            maxZoom: 19,
            attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
        });

        const wmska = L.tileLayer.wms('https://ags.cuzk.cz/arcgis2/services/dmr4g/ImageServer/WMSServer?', {
            layers: 'dmr4g:GrayscaleHillshade'
        });

        // Ortofoto vrstva s posunem
        const ortofotoVrstva = L.tileLayer('./{z}/{x}/{y}.png', {
            minZoom: 17,
            maxZoom: 19,
            tileSize: 256,
            attribution: '&copy; MIKESKA ORTOFOTO'
        }).on('load', function () {
            const ortoContainer = ortofotoVrstva.getContainer();
            ortoContainer.style.transform = 'translate(-15px, 10px)';
        }).addTo(map);

        const wmsKatastr = L.tileLayer.wms('http://services.cuzk.cz/wms/local-KM-wms.asp', {
            layers: 'KN',
            format: 'image/png',
            transparent: true,
            version: '1.1.1',
            attribution: '&copy; ČÚZK'
        });
            
        const baseMaps = {
            "mapy.cz základní": mapycz,
            "mapy.cz zimní": mapywintercz,
            "mapy.cz ortofoto": mapyletecka,
            "mapy.cz turistická": mapyoutdoor,
            "WMS Reliéf (5G)": wmska,
            "Katastr nemovitostí": wmsKatastr
        };

        const overlayMaps = {
            "Webkamery": webcamMarker,
            "Ortofoto": ortofotoVrstva
        };

        const layerControl = L.control.layers(baseMaps, overlayMaps).addTo(map);
        L.control.scale().addTo(map);

        document.getElementById('homeButton').addEventListener('click', function () {
            map.setView(homePoint, 17);
        });

        // --- Potrubí ---
        $.getJSON('https://gist.githubusercontent.com/MetrPikeska/c2970d584b33128b942c408d0e4a3cbc/raw/144f15981f8042078817e29d7ab4d2b989d902cc/.geojson', function (data) {
            const potrubi = L.geoJSON(data, {
                style: function () {
                    return { color: 'blue', weight: 2, dashArray: '10, 10' };
                }
            }).addTo(map);

            overlayMaps["Potrubí"] = potrubi;
            layerControl.addOverlay(potrubi, "Potrubí");
        });

        // --- Vleky s dynamickou barvou ---
        let vlekyLayer;

        $.getJSON('https://gist.githubusercontent.com/MetrPikeska/ca5795b2be4bddc3989b450284b1d8a9/raw/0485ce84414da1ee749439b051ef2ed3683f589a/vleky.geojson', function (data) {
            vlekyLayer = L.geoJSON(data, {
                style: function () {
                    return { color: 'green', weight: 5 };
                }
            }).addTo(map);

            overlayMaps["Vleky"] = vlekyLayer;
            layerControl.addOverlay(vlekyLayer, "Vleky");
        });

        function updateVlekyColor(count) {
            let color = "green";
            if (count >= 2 && count <= 4) {
                color = "orange";
            } else if (count > 4) {
                color = "red";
            }
            if (vlekyLayer) {
                vlekyLayer.setStyle({
                    color: color,
                    weight: 5
                });
            }
        }

        function updateSheepCount(count) {
            document.querySelector('#sheepInfo .count').textContent = count;
        }

        // --- Nová funkce pro tahání dat z hostingu ---
        function fetchSheepFromHosting() {
            fetch('get_sheep.php')
                .then(res => res.json())
                .then(data => {
                    const count = data.count || 0;
                    updateSheepCount(count);
                    updateVlekyColor(count);
                })
                .catch(err => console.error("Chyba při načítání z hostingu:", err));
        }

        // Každé 2 sekundy dotaz na hosting
        setInterval(fetchSheepFromHosting, 2000);

        // --- Ovládání grafu ---
        document.getElementById('showGraphBtn').addEventListener('click', function () {
            document.getElementById('graphModal').style.display = 'block';

            fetch('get_sheep.php?history=1')  // uprav PHP, aby vracel pole [{timestamp, count}, ...]
                .then(res => res.json())
                .then(data => {
                    const labels = data.map(d => d.timestamp);
                    const counts = data.map(d => d.count);

                    const ctx = document.getElementById('sheepChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Počet ovcí',
                                data: counts,
                                borderColor: 'blue',
                                backgroundColor: 'rgba(0,125,221,0.2)',
                                tension: 0.3,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                x: { title: { display: true, text: 'Čas' } },
                                y: { title: { display: true, text: 'Počet ovcí' }, beginAtZero: true }
                            }
                        }
                    });
                })
                .catch(err => console.error("Chyba při načítání historie:", err));
        });

        });
    </script>
</body>
</html>
